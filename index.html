<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èƒ¡æ™ºå¼·çš„å€‹äººé é¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }
        header {
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 20px 0;
        }
        .container {
            width: 80%;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            /* footer fixed æœƒè“‹åˆ°å…§å®¹ï¼Œé€™è£¡å¤šç•™åº•éƒ¨ç©ºé–“ */
            padding-bottom: 70px;
        }
        h1 { color: #333; }
        p {
            line-height: 1.6;
            color: #555;
        }
        .social-links { list-style-type: none; padding: 0; }
        .social-links li { display: inline-block; margin-right: 10px; }
        .social-links a { text-decoration: none; color: #4CAF50; font-size: 18px; }
        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        .tabs {
            margin: 20px 0;
            text-align: center;
        }
        .tabs button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .tabs button:hover { background-color: #45a049; }
        .tab-content { display: none; }
        .active { display: block; }

        /* ===== è¡€å£“åµæ¸¬é ï¼šå°‘é‡è£œå……æ¨£å¼ï¼ˆä¸å½±éŸ¿å…¶ä»–é ï¼‰ ===== */
        .bp-card {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 12px;
            margin: 12px 0;
            background: #fafafa;
        }
        .bp-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .bp-kpi {
            font-size: 20px;
            font-weight: bold;
            color: #222;
        }
        .bp-img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
        .bp-input { padding: 6px 8px; }
        .bp-btn {
            padding: 8px 12px;
            cursor: pointer;
            border: none;
            background: #4CAF50;
            color: #fff;
        }
        .bp-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .bp-small { color: #666; font-size: 12px; }
    </style>
</head>
<body>

<header>
    <h1>æ­¡è¿ä¾†åˆ°æˆ‘çš„å€‹äººé é¢</h1>
</header>

<div class="container">
    <!-- æŒ‰éˆ•åˆ— -->
    <div class="tabs">
        <button onclick="showTab('intro')">è‡ªæˆ‘ä»‹ç´¹</button>
        <button onclick="showTab('monitoring')">é ç«¯ç›£æ§</button>
        <button onclick="showTab('bloodPressure')">è¡€å£“åµæ¸¬</button>
    </div>

    <!-- åˆ†é å…§å®¹ï¼šè‡ªæˆ‘ä»‹ç´¹ -->
    <div id="intro" class="tab-content active">
        <h2>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡æ™ºå¼·</h2>
        <p>æˆ‘æ˜¯ä¸€åå­¸ç”Ÿï¼Œä¾†è‡ªé«˜é›„ç§‘æŠ€å¤§å­¸é›»å­å·¥ç¨‹ç³»å¤§å››ã€‚</p>

        <h3>è¯çµ¡æ–¹å¼</h3>
        <p>ä½ å¯ä»¥é€šéä»¥ä¸‹æ–¹å¼èˆ‡æˆ‘è¯ç¹«ï¼š</p>
        <ul class="social-links">
            <li><a href="mailto:c111252210@nkust.edu.tw">Email</a></li>
        </ul>
    </div>

    <!-- åˆ†é å…§å®¹ï¼šé ç«¯ç›£æ§ -->
    <div id="monitoring" class="tab-content">
  <h2>é ç«¯ç›£æ§ï¼ˆESP32-CAMï¼‰</h2>

  <div class="bp-card">
    <div class="bp-row">
      <label>ESP32-CAM ä½å€ï¼š</label>
      <input id="camIp" class="bp-input" placeholder="ä¾‹å¦‚ http://192.168.1.87 æˆ– /cam" style="min-width:260px" />
      <button id="camConnect" class="bp-btn">é€£ç·š</button>
      <span id="camStatus" class="bp-small" style="color:#4CAF50;">æœªé€£ç·š</span>
    </div>
  </div>

  <div class="bp-card">
    <img id="camStream" alt="stream" style="width:100%;max-width:960px;border-radius:10px;background:#000;" />
  </div>

  <div class="bp-card">
    <div class="bp-row">
      <button id="camSnap"  class="bp-btn" style="background:#2e6df6;">ğŸ“¸ Snapshot</button>
      <button id="camLed"   class="bp-btn" style="background:#444;">ğŸ’¡ LED</button>
      <button id="camClear" class="bp-btn" style="background:#444;">æ¸…é™¤è­¦å ±</button>
      <span id="camAlarm" class="bp-small" style="margin-left:8px;color:#9be26d;">System Normal</span>
    </div>
  </div>

  <p class="bp-small">
    æç¤ºï¼šè‹¥ä½ çš„ç¶²ç«™æ˜¯ HTTPSã€ç›¸æ©Ÿæ˜¯ HTTPï¼Œç€è¦½å™¨æœƒæ“‹ã€Œæ··åˆå…§å®¹ã€ã€‚å¯å…ˆåœ¨åŒå€ç¶²ç”¨ HTTP æ¸¬è©¦ï¼Œæˆ–æ–¼ä¼ºæœå™¨åšåå‘ä»£ç†ï¼ˆæŠŠæ¿å­ IP ä»£ç†æˆ /camï¼‰ã€‚
  </p>
</div>

    <!-- åˆ†é å…§å®¹ï¼šè¡€å£“åµæ¸¬ -->
    <div id="bloodPressure" class="tab-content">
        <h2>è¡€å£“åµæ¸¬</h2>
        <p class="bp-small">
            èªªæ˜ï¼šä¸Šå‚³è¡€å£“è¨ˆç…§ç‰‡ï¼ˆå»ºè­°å…ˆè£åˆ‡åˆ°è¢å¹•ã€é¿å…åå…‰ï¼‰â†’ å‘¼å« Hugging Face Space çš„ PaliGemma API â†’
            å–å¾— SYS / DIA / PUL â†’ å†ç”¨ä½ è¼¸å…¥çš„ç·šæ€§è¶¨å‹¢ä¿‚æ•¸åˆ¤æ–·æ˜¯å¦è„«æ¨¡ã€‚
        </p>

        <div class="bp-card">
            <div class="bp-row">
                <input id="bpFile" class="bp-input" type="file" accept="image/*">
                <button id="bpRecognizeBtn" class="bp-btn" disabled>è¾¨è­˜</button>
                <span id="bpStatus" class="bp-small">è¼‰å…¥ä¸­â€¦</span>
            </div>
        </div>

        <div class="bp-card">
            <div>é è¦½ï¼š</div>
            <img id="bpPreview" class="bp-img" alt="">
        </div>

        <div class="bp-card">
            <div class="bp-kpi">è¾¨è­˜çµæœ</div>
            <div id="bpResult">å°šæœªè¾¨è­˜</div>
        </div>

        <div id="bpTrend" style="margin-top:10px;"></div>
        <button id="bpExportBtn" type="button">åŒ¯å‡º bp_dataï¼ˆJSONï¼‰</button>

            <div class="bp-small">â€» åƒ…ä¾›å°ˆé¡Œå±•ç¤ºåƒè€ƒï¼Œä¸èƒ½æ›¿ä»£é†«ç™‚å»ºè­°</div>
        </div>

        <div id="bpHistoryCard" class="bp-card" style="display:none;">
            <div class="bp-kpi">æ­·å²ç´€éŒ„ï¼ˆlocalStorageï¼‰</div>
            <div class="bp-row">
                <button id="bpClearBtn" class="bp-btn">æ¸…ç©ºç´€éŒ„</button>
                <span class="bp-small">ï¼ˆåªæœƒæ¸…ä½ é€™å€‹ç€è¦½å™¨çš„ç´€éŒ„ï¼‰</span>
                <div id="bpHistory" style="margin-top:8px;"></div>
            </div>
    </div>
</div>

<footer>
    <p>Â© 2025 èƒ¡æ™ºå¼·. All Rights Reserved.</p>
</footer>

<script>
    function showTab(tabName) {
        const tabs = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => tab.classList.remove('active'));

        const activeTab = document.getElementById(tabName);
       
// Hide history card at load if not on bloodPressure
(function(){
  const bpHist = document.getElementById('bpHistoryCard');
  if (bpHist) { bpHist.style.display = document.getElementById('bloodPressure')?.classList.contains('active') ? '' : 'none'; }
})();
 activeTab.classList.add('active');
    
        // Toggle BP history card visibility only on bloodPressure tab
        const bpHist = document.getElementById('bpHistoryCard');
        if (bpHist) { bpHist.style.display = (tabName === 'bloodPressure') ? '' : 'none'; }
}
</script>

<script>
  // ===== é ç«¯ç›£æ§ï¼ˆESP32-CAMï¼‰æ•´åˆ =====
  (function(){
    const ipInput = document.getElementById('camIp');
    const stream  = document.getElementById('camStream');
    const statusEl= document.getElementById('camStatus');
    const alarmEl = document.getElementById('camAlarm');
    const btnConn = document.getElementById('camConnect');
    const btnSnap = document.getElementById('camSnap');
    const btnLed  = document.getElementById('camLed');
    const btnClr  = document.getElementById('camClear');

    if(!ipInput) return;

    const ok  = (msg)=>{ statusEl.textContent = msg||'OK'; statusEl.style.color = '#4CAF50'; }
    const bad = (msg)=>{ statusEl.textContent = msg||'éŒ¯èª¤'; statusEl.style.color = '#ff6565'; }

    let CAM_BASE = localStorage.getItem('cam_base') || 'http://192.168.1.87';
    let ledOn = false, pollTimer = null;

    function setBase(url){
      CAM_BASE = (url||'').trim().replace(/\/+$/,'');
      if(!/^https?:\/\//.test(CAM_BASE) && !CAM_BASE.startsWith('/')) CAM_BASE = 'http://' + CAM_BASE;
      localStorage.setItem('cam_base', CAM_BASE);
      ipInput.value = CAM_BASE;
      stream.src = CAM_BASE + '/stream';
      ok('é€£ç·šä¸­â€¦');
      if (pollTimer) clearTimeout(pollTimer);
      poll();
    }

    async function poll(){
      try{
        const r = await fetch(CAM_BASE + '/status', { mode:'cors' });
        const j = await r.json();
        alarmEl.textContent = j.alarm ? 'âš  ALARM TRIGGERED' : 'System Normal';
        alarmEl.style.color = j.alarm ? '#ff6565' : '#9be26d';
        ok('é€£ç·šä¸­');
      }catch(e){
        bad('ç„¡æ³•å–å¾—ç‹€æ…‹'); 
      }finally{
        pollTimer = setTimeout(poll, 1500);
      }
    }

    btnConn?.addEventListener('click', ()=> setBase(ipInput.value || CAM_BASE));

    btnSnap?.addEventListener('click', async ()=>{
      try{
        const r = await fetch(CAM_BASE + '/snapshot');
        if(!r.ok) throw new Error('snapshot failed');
        const b = await r.blob();
        const url = URL.createObjectURL(b);
        const a = document.createElement('a');
        a.href = url; a.download = 'snapshot.jpg'; a.click();
        URL.revokeObjectURL(url);
      }catch(e){ bad('snapshot å¤±æ•—'); }
    });

    btnLed?.addEventListener('click', async ()=>{
      try{
        ledOn = !ledOn;
        await fetch(CAM_BASE + '/led?on=' + (ledOn?1:0));
        btnLed.textContent = ledOn ? 'ğŸ’¡ LED (ON)' : 'ğŸ’¡ LED';
      }catch(e){ bad('LED å¤±æ•—'); }
    });

    btnClr?.addEventListener('click', async ()=>{ try{ await fetch(CAM_BASE + '/reset_alarm'); }catch(e){} });

    stream.onerror = ()=> setTimeout(()=>{ stream.src = CAM_BASE + '/stream'; }, 3000);

    // åˆæ¬¡è¼‰å…¥å°±è‡ªå‹•æ¥å‰æ¬¡è¨­å®š
    ipInput.value = CAM_BASE;
    setBase(CAM_BASE);
  })();
</script>

<!-- è¡€å£“åµæ¸¬ä¸»ç¨‹å¼ -->
<script src="./bp.js?v=20260104"></script>

</body>
</html>
